# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Scope of Work

**IMPORTANT**: Claude should work exclusively on project and code documentation. This includes:

- Docstrings (Sphinx RST format)
- README.md updates and improvements
- CLAUDE.md updates
- Code examples in documentation
- API reference documentation
- Usage guides and tutorials

**Do NOT**:
- Implement new features or functionality
- Fix bugs or refactor code
- Modify business logic
- Change dependencies or configurations
- Make commits or deploy code

If asked to perform non-documentation work, politely redirect to documentation tasks.

## Project Overview

`fastapi-roundtable` is a FastAPI integration library for Roundtable.ai Proof-of-Human bot detection. It provides backend session validation to protect FastAPI endpoints from automated bots by validating session IDs generated by Roundtable's frontend JavaScript tracker against their risk scoring API.

**Repository**: github.com/leandropls/fastapi-roundtable
**PyPI Package**: pypi.org/project/fastapi-roundtable
**License**: MIT

## Architecture

This is a minimal library (2 Python files, ~90 lines of code) with a focused purpose:

### Core Components

- **`fastapi_roundtable/main.py`**: Contains the `Roundtable` class, which is the main integration point
  - Acts as a FastAPI dependency factory via `__call__` method
  - Uses aiohttp for async HTTP requests to Roundtable API
  - Validates session IDs by querying `https://api.roundtable.ai/v1/sessions/report`
  - Raises `HTTPException` when validation fails or risk score exceeds threshold

- **`fastapi_roundtable/__init__.py`**: Package initialization, exports `Roundtable` class

### Key Design Patterns

1. **Dependency Injection**: The `Roundtable` class instance is callable and returns an async function that FastAPI can use as a dependency via `Depends()`

2. **Multiple Session Sources**: The `__call__` method accepts one of three mutually exclusive parameters:
   - `form_field`: Extract session ID from form data
   - `http_header`: Extract session ID from HTTP header
   - `body_field`: Extract session ID from request body

3. **Persistent HTTP Session**: Uses a single `aiohttp.ClientSession` instance stored in `self.aiohttp_session` for connection pooling

## Environment Setup

For working on documentation, you may need to install dependencies to test examples:

```bash
# Install Poetry if needed
pip install poetry

# Install dependencies
poetry install
```

## Documentation Guidelines

This project uses **Sphinx RST-style docstrings** with specific conventions:

1. **No type documentation** - Types are already in type annotations, don't duplicate in docstrings
2. **Function documentation** - Focus on WHAT functions do (user perspective), not HOW they do it
3. **Class documentation** - Describe what an instance represents, not implementation details
4. **Skip private attributes** - Don't document attributes prefixed with `_`
5. **Brief examples** - Include concise usage examples where helpful

Example docstring format:
```python
def validate_session(self, session_id: str) -> None:
    """Validate a session ID against the Roundtable.ai API.

    Queries the Roundtable.ai API to retrieve the risk score for the given
    session and checks if it exceeds the configured threshold.

    :param session_id: The session identifier to validate.
    :raises HTTPException: If the API request fails or if the session's risk
                          score exceeds the configured max_risk_score.
    """
```

## Integration Context

### How Roundtable.ai Works
- Frontend: JavaScript tracker (`https://cdn.roundtable.ai/v1/rt.js`) monitors user behavior
- Session ID is stored in `sessionStorage.rtSessionId` by the tracker
- Forms must manually include a hidden field and populate it via JavaScript polling:
  ```javascript
  const interval = setInterval(() => {
      if (sessionStorage.getItem('rtSessionId')) {
          clearInterval(interval);
          document.getElementById("rt_session_id").value = sessionStorage.getItem('rtSessionId');
      }
  }, 500);
  ```
- Backend (this library) validates the session ID against Roundtable's API
- Risk scores range 0-100 (higher = more suspicious), default threshold is 50

### Example Reference Implementation
See `/Users/leandro/dev/roundtable/fastapi-demo` for a complete working example showing:
- Frontend HTML with Roundtable tracker integration
- Form with hidden `rt_session_id` field
- FastAPI backend using this library
- Custom error handling for failed validations

## Important Notes

- **Python Version**: Requires Python 3.9+ (uses union type syntax `str | None`)
- **Async Only**: All validation is async using aiohttp, not compatible with sync FastAPI routes
- **Environment Variables**: API key can be provided via `ROUNDTABLE_API_KEY` env var
- **Error Codes**: Default status code is 404 (makes bot detection less obvious to attackers)
- **Risk Threshold**: Default `max_risk_score` is 50, adjust based on your security needs

## Code Style

- **Black**: Line length 100
- **isort**: Black-compatible profile
- **mypy**: Type checking enabled with `check_untyped_defs = true`
- **No emojis**: Professional package, avoid emojis in code and documentation unless explicitly requested
